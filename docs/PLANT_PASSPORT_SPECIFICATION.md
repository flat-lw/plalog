# plalog 植物エクスポート機能仕様書

## 概要

本ドキュメントは、植物を譲渡・販売する際に、その植物の管理履歴をエクスポートする機能を定義する。

### 目的

- 植物を受け取る人が過去の管理情報を参照できる
- 育成ノウハウの継承
- 植物の「履歴書」として価値を付加

### 出力形式

| 形式 | 用途 |
|------|------|
| JSON | アプリ間のデータ移行、インポート用 |
| PDF | 印刷・共有用、人間可読 |

---

## ユーザー表示名

### 設定画面

エクスポート時に表示される名前を事前に登録。

```
┌─────────────────────────────────┐
│ ← 設定                   ≡     │
├─────────────────────────────────┤
│                                 │
│  ユーザー設定                   │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  表示名                         │
│  ┌───────────────────────────┐  │
│  │ 園芸太郎                  │  │
│  └───────────────────────────┘  │
│  植物をエクスポートする際に      │
│  この名前が表示されます          │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  連絡先（任意）                 │
│  ┌───────────────────────────┐  │
│  │ @engei_taro               │  │
│  └───────────────────────────┘  │
│  SNSアカウントなど              │
│                                 │
└─────────────────────────────────┘
```

### データ構造

```typescript
// src/db/models/userProfile.ts

interface UserProfile {
  id: string              // 固定値 'default'
  displayName?: string    // 表示名
  contact?: string        // 連絡先（任意）
  createdAt: Date
  updatedAt: Date
}
```

### Dexieスキーマ

```typescript
this.version(3).stores({
  // 既存テーブル...
  userProfile: 'id',
})
```

---

## エクスポートデータ構造

### JSON形式

```typescript
// src/features/export/types/plantPassport.ts

interface PlantPassport {
  // メタ情報
  version: 1
  exportedAt: string        // ISO8601
  app: 'plalog'
  
  // エクスポート者情報
  exportedBy: {
    displayName?: string
    contact?: string
  }
  
  // 植物基本情報
  plant: {
    species?: string        // 種名
    acquiredAt?: string     // 入手日
    notes?: string          // メモ（公開用に編集可能）
  }
  
  // 管理サマリー
  summary: {
    managementDays: number  // 管理日数
    wateringCount: number   // 水やり回数
    avgWateringInterval: number  // 平均水やり間隔（日）
    repottingCount: number  // 植替え回数
    floweringCount: number  // 開花回数
  }
  
  // 環境サマリー（オプション）
  environment?: {
    tempMin: number         // 最低気温
    tempMax: number         // 最高気温
    tempAvg: number         // 平均気温
    humidityAvg?: number    // 平均湿度
    placement?: string      // 置き場所の種類
  }
  
  // 成長イベント履歴
  growthEvents: {
    date: string            // YYYY-MM-DD
    type: GrowthEventType
    notes?: string
  }[]
  
  // 開花記録
  floweringRecords: {
    year: number
    budDate?: string
    bloomDate?: string
    endDate?: string
    petalCount?: number
    color?: string
    notes?: string
  }[]
  
  // 水やり統計（詳細は含めない）
  wateringStats: {
    periodFrom: string      // 記録開始日
    periodTo: string        // 記録終了日
    totalCount: number
    monthlyAverage: number  // 月平均回数
  }
}
```

### サンプルJSON

```json
{
  "version": 1,
  "exportedAt": "2025-12-29T15:00:00.000Z",
  "app": "plalog",
  "exportedBy": {
    "displayName": "園芸太郎",
    "contact": "@engei_taro"
  },
  "plant": {
    "species": "Monstera deliciosa",
    "acquiredAt": "2023-04-15",
    "notes": "実生から育てました。丈夫で育てやすいです。"
  },
  "summary": {
    "managementDays": 990,
    "wateringCount": 124,
    "avgWateringInterval": 8,
    "repottingCount": 2,
    "floweringCount": 0
  },
  "environment": {
    "tempMin": 15,
    "tempMax": 30,
    "tempAvg": 22,
    "humidityAvg": 55,
    "placement": "室内・窓際"
  },
  "growthEvents": [
    { "date": "2023-04-15", "type": "acquisition", "notes": "種子から発芽" },
    { "date": "2023-08-20", "type": "repotting", "notes": "3号→5号鉢" },
    { "date": "2024-05-10", "type": "repotting", "notes": "5号→7号鉢" },
    { "date": "2024-06-15", "type": "newLeaf", "notes": "切れ込み入りの葉" }
  ],
  "floweringRecords": [],
  "wateringStats": {
    "periodFrom": "2023-04-15",
    "periodTo": "2025-12-29",
    "totalCount": 124,
    "monthlyAverage": 4.5
  }
}
```

---

## PDF出力

### レイアウト

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│                    🌱 Plant Passport                    │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  種名: Monstera deliciosa                               │
│  管理者: 園芸太郎（@engei_taro）                         │
│  管理期間: 2023/04/15 〜 2025/12/29（2年8ヶ月）          │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  📊 管理サマリー                                        │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │  💧 水やり     124回（平均8日間隔）             │    │
│  │  🪴 植替え     2回                              │    │
│  │  🌸 開花       なし                             │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  🌡 環境                                                │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │  気温: 15〜30℃（平均22℃）                      │    │
│  │  湿度: 平均55%                                  │    │
│  │  場所: 室内・窓際                               │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  📝 成長の記録                                          │
│                                                         │
│  2023/04/15  入手      種子から発芽                     │
│  2023/08/20  植替え    3号→5号鉢                        │
│  2024/05/10  植替え    5号→7号鉢                        │
│  2024/06/15  新葉      切れ込み入りの葉                 │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  📝 メモ                                                │
│                                                         │
│  実生から育てました。丈夫で育てやすいです。              │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  Exported from plalog                                   │
│  2025/12/29                                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### PDF生成

```typescript
// jsPDFを使用
import { jsPDF } from 'jspdf'

async function generatePlantPassportPdf(
  passport: PlantPassport
): Promise<Blob> {
  const doc = new jsPDF()
  
  // フォント設定（日本語対応）
  // ...
  
  // タイトル
  doc.setFontSize(24)
  doc.text('🌱 Plant Passport', 105, 20, { align: 'center' })
  
  // 基本情報
  doc.setFontSize(12)
  doc.text(`種名: ${passport.plant.species}`, 20, 40)
  doc.text(`管理者: ${passport.exportedBy.displayName}`, 20, 50)
  // ...
  
  return doc.output('blob')
}
```

---

## UI設計

### 植物詳細画面

```
┌─────────────────────────────────┐
│ ← モンステラ            編集   │
├─────────────────────────────────┤
│                                 │
│  種名: Monstera deliciosa       │
│  入手: 2023/04/15               │
│                                 │
│  ...（既存の表示）              │
│                                 │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                 │
│  ┌───────────────────────────┐  │
│  │  📤 この植物をエクスポート │  │
│  └───────────────────────────┘  │
│                                 │
└─────────────────────────────────┘
```

### エクスポート設定画面

```
┌─────────────────────────────────┐
│ ← エクスポート           ≡     │
├─────────────────────────────────┤
│                                 │
│  📤 モンステラの                │
│     Plant Passportを作成        │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  あなたの情報                   │
│  ┌───────────────────────────┐  │
│  │ 👤 園芸太郎               │  │
│  │ 📧 @engei_taro            │  │
│  │                    編集 → │  │
│  └───────────────────────────┘  │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  公開メモ（任意）               │
│  ┌───────────────────────────┐  │
│  │ 実生から育てました。       │  │
│  │ 丈夫で育てやすいです。     │  │
│  │                           │  │
│  └───────────────────────────┘  │
│  ※ 元のメモとは別に設定できます │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  含めるデータ                   │
│  ┌───────────────────────────┐  │
│  │ ☑ 管理サマリー            │  │
│  │ ☑ 成長イベント            │  │
│  │ ☑ 開花記録               │  │
│  │ ☐ 環境データ             │  │
│  └───────────────────────────┘  │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  出力形式                       │
│  ┌───────────────────────────┐  │
│  │ ☑ JSON（アプリ連携用）    │  │
│  │ ☑ PDF（印刷・共有用）     │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │      エクスポート          │  │
│  └───────────────────────────┘  │
│                                 │
└─────────────────────────────────┘
```

### エクスポート完了画面

```
┌─────────────────────────────────┐
│ ← エクスポート完了        ≡     │
├─────────────────────────────────┤
│                                 │
│            ✅                   │
│     エクスポート完了            │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  作成されたファイル             │
│                                 │
│  ┌───────────────────────────┐  │
│  │ 📄 monstera_passport.json │  │
│  │    8.2 KB                 │  │
│  │                    共有 → │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │ 📄 monstera_passport.pdf  │  │
│  │    124 KB                 │  │
│  │                    共有 → │  │
│  └───────────────────────────┘  │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  💡 ファイルを植物と一緒に       │
│     お渡しください              │
│                                 │
└─────────────────────────────────┘
```

---

## インポート機能

### インポート画面

```
┌─────────────────────────────────┐
│ ← Plant Passportインポート ≡   │
├─────────────────────────────────┤
│                                 │
│  📥 Plant Passportを読み込んで  │
│     植物を登録できます          │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  ┌───────────────────────────┐  │
│  │  📁 JSONファイルを選択    │  │
│  └───────────────────────────┘  │
│                                 │
└─────────────────────────────────┘
```

### インポートプレビュー

```
┌─────────────────────────────────┐
│ ← インポート確認          ≡     │
├─────────────────────────────────┤
│                                 │
│  📋 Plant Passport              │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  種名: Monstera deliciosa       │
│  前の管理者: 園芸太郎           │
│  管理期間: 2年8ヶ月             │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  含まれるデータ                 │
│  ┌───────────────────────────┐  │
│  │ ✓ 成長イベント: 4件       │  │
│  │ ✓ 開花記録: 0件           │  │
│  │ ✓ 水やり統計              │  │
│  │ ✓ 環境データ              │  │
│  └───────────────────────────┘  │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  この植物の名前                 │
│  ┌───────────────────────────┐  │
│  │ モンステラ                │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │       インポート          │  │
│  └───────────────────────────┘  │
│                                 │
└─────────────────────────────────┘
```

### インポート後の植物詳細

```
┌─────────────────────────────────┐
│ ← モンステラ            編集   │
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────────────┐  │
│  │ 📋 引き継ぎデータあり      │  │
│  │                           │  │
│  │ 前の管理者: 園芸太郎       │  │
│  │ 管理期間: 2年8ヶ月         │  │
│  │ 引き継ぎ日: 2025/12/29     │  │
│  └───────────────────────────┘  │
│                                 │
│  種名: Monstera deliciosa       │
│  入手: 2023/04/15               │
│                                 │
│  ...                            │
│                                 │
└─────────────────────────────────┘
```

---

## データベース拡張

### Plantテーブルに追加

```typescript
interface Plant {
  // 既存フィールド...
  
  // 引き継ぎ情報（インポート時に設定）
  inheritedFrom?: {
    displayName?: string
    contact?: string
    managementDays: number
    importedAt: Date
  }
}
```

---

## 実装ファイル構成

```
src/features/plant-passport/
├── components/
│   └── UserProfileEditor.tsx      # ユーザープロフィール編集
├── hooks/
│   ├── useExportPassport.ts       # エクスポート処理
│   └── useUserProfile.ts          # ユーザープロフィール
├── pages/
│   └── PlantPassportExportPage.tsx # エクスポート設定画面
├── services/
│   ├── passportBuilder.ts         # データ収集・構築
│   └── pdfGenerator.ts            # PDF生成（jsPDF使用）
├── types/
│   └── index.ts                   # 型定義
└── index.ts
```

---

## 実装状況

### 実装済み機能

| 機能 | 状態 | 備考 |
|------|------|------|
| ユーザープロフィール設定 | ✅ 完了 | displayName, contact |
| JSONエクスポート | ✅ 完了 | PlantPassport形式 |
| PDFエクスポート | ✅ 完了 | jsPDF使用 |
| エクスポート設定UI | ✅ 完了 | 含めるデータ選択可能 |
| 植物詳細からの導線 | ✅ 完了 | エクスポートボタン |

### 未実装/将来対応

| 機能 | 状態 | 備考 |
|------|------|------|
| Plant Passportインポート | 📋 計画中 | JSONからの植物登録 |
| 引き継ぎバッジ表示 | 📋 計画中 | inheritedFromの表示UI |
| インポートプレビュー | 📋 計画中 | データ確認画面 |

---

## プライバシー考慮

| データ | 扱い |
|--------|------|
| 植物名（ユーザー命名） | 含めない（種名のみ） |
| 場所の名前 | 含めない |
| 場所の詳細 | 「室内」「屋外」など抽象化 |
| 水やり詳細日時 | 含めない（統計のみ） |
| 表示名・連絡先 | ユーザーが任意で設定 |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2024-12-29 | 1.0 | 初版作成 |
| 2024-12-30 | 1.1 | 実装状況セクション追加、ファイル構成を実装に合わせて更新 |
