# plalog Google Drive連携仕様書

## 概要

本ドキュメントは、plalogにおけるGoogle Drive連携機能の設計を定義する。

### 目的

- 複数デバイス間でのデータ同期
- ブラウザのデータ消失に対するバックアップ
- ユーザーが自身のデータを管理できる透明性

### 基本方針

- **クライアントサイド完結**: サーバーを経由せず、ブラウザから直接Google APIを呼び出す
- **App Data Folder使用**: ユーザーのGoogle Drive内の非公開領域に保存
- **手動同期**: 自動同期ではなく、ユーザーの明示的な操作で同期
- **全体同期**: 差分同期ではなく、全データを一括で同期

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザーのブラウザ                     │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   React     │    │  IndexedDB  │    │   Google    │  │
│  │   アプリ    │←──→│  (Dexie)    │    │  Identity   │  │
│  │             │    │             │    │  Services   │  │
│  └──────┬──────┘    └─────────────┘    └──────┬──────┘  │
│         │                                      │        │
│         │        OAuth 2.0 Token               │        │
│         │←─────────────────────────────────────┘        │
│         │                                               │
│         ▼                                               │
│  ┌─────────────┐                                        │
│  │  Google     │                                        │
│  │  Drive API  │                                        │
│  └──────┬──────┘                                        │
└─────────┼───────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────┐
│                  Google Drive                           │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │  App Data Folder（非公開領域）                   │    │
│  │  ┌─────────────────────────────────────────┐    │    │
│  │  │  plalog-data.json                       │    │    │
│  │  └─────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

---

## OAuth 2.0 認証

### 使用するスコープ

```
https://www.googleapis.com/auth/drive.appdata
```

| スコープ | 権限 | 選定理由 |
|----------|------|----------|
| drive.appdata | App Data Folderへのアクセス | ユーザーのDriveを汚さない、制限付きスコープではない |

### 認証フロー

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐
│  ユーザー │     │   plalog    │     │   Google    │
└────┬────┘     └──────┬──────┘     └──────┬──────┘
     │                 │                   │
     │  連携ボタン押下  │                   │
     │────────────────>│                   │
     │                 │                   │
     │                 │  認証リクエスト    │
     │                 │──────────────────>│
     │                 │                   │
     │          Googleログイン画面          │
     │<────────────────────────────────────│
     │                 │                   │
     │  ログイン・同意  │                   │
     │────────────────────────────────────>│
     │                 │                   │
     │                 │  アクセストークン  │
     │                 │<──────────────────│
     │                 │                   │
     │  連携完了       │                   │
     │<────────────────│                   │
     │                 │                   │
```

### 認証方式

| 項目 | 値 |
|------|-----|
| 認証方式 | OAuth 2.0 Implicit Grant Flow |
| ライブラリ | Google Identity Services (GIS) |
| トークン保存 | メモリ内のみ（セキュリティのため永続化しない） |
| トークン有効期限 | 1時間（Google標準） |

---

## Google Cloud Console 設定

### プロジェクト設定

| 項目 | 値 |
|------|-----|
| プロジェクト名 | plalog |
| 有効にするAPI | Google Drive API |

### OAuth 同意画面

| 項目 | 値 |
|------|-----|
| アプリ名 | plalog |
| User Type | 外部 |
| スコープ | drive.appdata |
| 公開ステータス | テスト（開発中）/ 本番（公開後） |

### OAuth クライアントID

| 項目 | 値 |
|------|-----|
| アプリケーションの種類 | ウェブ アプリケーション |
| 名前 | plalog Web Client |
| 承認済みJavaScript生成元 | `http://localhost:5173`<br>`https://plalog.pages.dev` |

---

## API 仕様

### 保存ファイル

| 項目 | 値 |
|------|-----|
| ファイル名 | `plalog-data.json` |
| 保存場所 | App Data Folder |
| MIME Type | `application/json` |
| 最大サイズ | 5MB（実用上問題なし） |

### 使用するAPI エンドポイント

| 操作 | メソッド | エンドポイント |
|------|----------|----------------|
| ファイル検索 | GET | `https://www.googleapis.com/drive/v3/files` |
| ファイル作成 | POST | `https://www.googleapis.com/upload/drive/v3/files` |
| ファイル更新 | PATCH | `https://www.googleapis.com/upload/drive/v3/files/{fileId}` |
| ファイル取得 | GET | `https://www.googleapis.com/drive/v3/files/{fileId}` |

---

## データ形式

### エクスポートデータ構造

```typescript
interface GoogleDriveSyncData {
  // メタ情報
  version: number           // データ形式バージョン
  app: 'plalog'             // アプリ識別子
  syncedAt: string          // 同期日時（ISO8601）
  
  // アプリデータ
  data: {
    plants: Plant[]
    locations: Location[]
    plantLocationHistory: PlantLocationHistory[]
    wateringLogs: WateringLog[]
    growthEvents: GrowthEvent[]
    floweringRecords: FloweringRecord[]
    environmentLogs: EnvironmentLog[]
  }
}
```

### バージョン管理

| version | 変更内容 |
|---------|----------|
| 1 | 初版 |

将来データ形式が変わる場合、versionを上げてマイグレーション処理を実装する。

---

## 同期処理

### アップロード処理

```
1. IndexedDBから全データを取得
2. GoogleDriveSyncData形式に変換
3. App Data Folder内のファイルを検索
4. ファイルが存在する場合: 上書き更新（PATCH）
5. ファイルが存在しない場合: 新規作成（POST）
6. 成功/失敗をユーザーに通知
```

```typescript
async function upload(): Promise<void> {
  // 1. データ取得
  const exportData = await exportAllData()
  
  // 2. 形式変換
  const syncData: GoogleDriveSyncData = {
    version: 1,
    app: 'plalog',
    syncedAt: new Date().toISOString(),
    data: exportData,
  }
  
  // 3. ファイル検索
  const fileId = await findFile('plalog-data.json')
  
  // 4-5. アップロード
  if (fileId) {
    await updateFile(fileId, syncData)
  } else {
    await createFile(syncData)
  }
}
```

### ダウンロード処理

```
1. App Data Folder内のファイルを検索
2. ファイルが存在しない場合: 処理終了（データなし）
3. ファイル内容を取得
4. データ形式を検証
5. 既存データをクリア
6. 新しいデータをインポート
7. 成功/失敗をユーザーに通知
```

```typescript
async function download(): Promise<void> {
  // 1. ファイル検索
  const fileId = await findFile('plalog-data.json')
  
  // 2. 存在チェック
  if (!fileId) {
    throw new Error('同期データが見つかりません')
  }
  
  // 3. 取得
  const syncData = await getFileContent(fileId)
  
  // 4. 検証
  if (syncData.app !== 'plalog') {
    throw new Error('無効なデータ形式です')
  }
  
  // 5-6. インポート
  await importAllData(syncData.data)
}
```

### 競合解決

| 方針 | 説明 |
|------|------|
| 手動同期のため競合なし | ユーザーが明示的にアップロード/ダウンロードを選択 |
| 上書き確認 | ダウンロード時に既存データが上書きされる旨を警告 |

---

## エラーハンドリング

### エラー種別と対応

| エラー | 原因 | ユーザーへの表示 | 対応 |
|--------|------|------------------|------|
| 認証エラー | ユーザーがキャンセル、権限不足 | 「認証に失敗しました」 | 再認証を促す |
| ネットワークエラー | オフライン、タイムアウト | 「通信エラーが発生しました」 | リトライを促す |
| ファイル未検出 | 初回同期前 | 「同期データが見つかりません」 | まずアップロードを促す |
| データ形式エラー | 破損、別アプリのデータ | 「データを読み込めませんでした」 | 手動でのエクスポート/インポートを案内 |
| クォータ超過 | Driveの容量不足 | 「Google Driveの容量が不足しています」 | Drive容量の確認を促す |

### エラー表示例

```tsx
{error && (
  <div className="p-3 bg-red-100 text-red-700 rounded">
    <p className="font-bold">エラー</p>
    <p>{error}</p>
    <button onClick={retry} className="mt-2 underline">
      再試行
    </button>
  </div>
)}
```

---

## UI 設計

### 設定画面への配置

```
ハンバーガーメニュー
├── データエクスポート
├── データインポート
├── Google Drive 同期    ← ここ
└── このアプリについて
```

### Google Drive 同期画面

```
┌─────────────────────────────────┐
│ ← Google Drive 同期      ≡     │
├─────────────────────────────────┤
│                                 │
│  Google Driveと連携して          │
│  データをバックアップできます。    │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  ステータス: 未連携              │
│                                 │
│  ┌───────────────────────────┐  │
│  │  🔗 Googleアカウントと連携  │  │
│  └───────────────────────────┘  │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  ⚠️ 注意事項                    │
│  • データはあなたのGoogle Drive  │
│    の非公開領域に保存されます    │
│  • 他のユーザーからは見えません  │
│  • 同期は手動で行います          │
│                                 │
└─────────────────────────────────┘
```

### 連携後の画面

```
┌─────────────────────────────────┐
│ ← Google Drive 同期      ≡     │
├─────────────────────────────────┤
│                                 │
│  ステータス: ✓ 連携済み          │
│  最終同期: 2024/12/28 15:30     │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  ┌───────────────────────────┐  │
│  │  ⬆️ Google Driveに保存    │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │  ⬇️ Google Driveから復元  │  │
│  └───────────────────────────┘  │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  ┌───────────────────────────┐  │
│  │      連携を解除           │  │
│  └───────────────────────────┘  │
│                                 │
└─────────────────────────────────┘
```

### 確認ダイアログ

#### アップロード確認

```
┌─────────────────────────────────┐
│  Google Driveに保存              │
├─────────────────────────────────┤
│                                 │
│  現在のデータをGoogle Driveに    │
│  保存します。                    │
│                                 │
│  既存のバックアップは            │
│  上書きされます。                │
│                                 │
│  ┌───────────┐  ┌───────────┐  │
│  │ キャンセル │  │   保存    │  │
│  └───────────┘  └───────────┘  │
└─────────────────────────────────┘
```

#### ダウンロード確認

```
┌─────────────────────────────────┐
│  Google Driveから復元            │
├─────────────────────────────────┤
│                                 │
│  ⚠️ 注意                        │
│                                 │
│  Google Driveのデータで          │
│  現在のデータを上書きします。     │
│                                 │
│  この操作は取り消せません。       │
│                                 │
│  ┌───────────┐  ┌───────────┐  │
│  │ キャンセル │  │   復元    │  │
│  └───────────┘  └───────────┘  │
└─────────────────────────────────┘
```

---

## セキュリティ

### 考慮事項

| 項目 | 対策 |
|------|------|
| アクセストークン | メモリ内のみ保持、永続化しない |
| スコープ最小化 | drive.appdataのみ使用 |
| データ暗号化 | Google Driveの標準暗号化に依存 |
| HTTPS | 必須（Google APIの要件） |

### App Data Folder の特性

- ユーザーの通常のGoogle Driveファイル一覧には表示されない
- 他のアプリからはアクセスできない
- ユーザーがアプリを削除すると、App Data Folderのデータも削除される

---

## テスト

### テストモード（100ユーザーまで）

1. OAuth同意画面の「テストユーザー」に自分のGoogleアカウントを追加
2. 公開ステータスは「テスト」のまま

### テスト項目

| 項目 | 確認内容 |
|------|----------|
| 認証 | Googleログインポップアップが表示される |
| 認証キャンセル | エラーメッセージが表示される |
| アップロード | 成功メッセージが表示される |
| アップロード（2回目） | 上書き更新が成功する |
| ダウンロード | データが正しく復元される |
| ダウンロード（未同期） | 「データなし」メッセージが表示される |
| 連携解除 | ステータスが「未連携」に戻る |
| オフライン | エラーメッセージが表示される |

---

## 本番公開（Google審査）

### 審査が必要な条件

- 100ユーザー以上に公開する場合

### 審査申請の準備

| 必要なもの | 内容 |
|------------|------|
| プライバシーポリシー | データの取り扱いを説明するページ |
| アプリのホームページ | plalogのURL |
| スコープの使用目的 | 「ユーザーのデータをバックアップするため」 |

### プライバシーポリシーに記載すべき内容

```
## Google Drive連携について

plalogはGoogle Drive APIを使用して、以下の目的でユーザーのGoogle Driveにアクセスします：

- アプリデータのバックアップ
- 複数デバイス間でのデータ同期

### 保存されるデータ
- 植物の登録情報
- 水やり記録
- 成長イベント記録
- 開花記録
- 場所情報
- 環境データ

### データの保存場所
データはユーザーのGoogle Drive内の「アプリデータ」領域に保存されます。
この領域は他のユーザーやアプリからアクセスできません。

### データの削除
ユーザーはいつでもGoogle Driveからデータを削除できます。
アプリの連携を解除すると、アプリからのアクセスは停止されます。
```

### 審査期間

| スコープ | 審査期間 |
|----------|----------|
| drive.appdata（非制限） | 1〜2週間 |
| drive.file（制限付き） | 4〜6週間 |

`drive.appdata`は制限付きスコープではないため、比較的早く審査が完了します。

---

## 実装ファイル構成

```
src/
├── features/
│   └── settings/
│       ├── components/
│       │   ├── GoogleDriveSync.tsx     # メインUI
│       │   ├── SyncStatusBadge.tsx     # ステータス表示
│       │   └── SyncConfirmDialog.tsx   # 確認ダイアログ
│       ├── hooks/
│       │   └── useGoogleDriveSync.ts   # 同期ロジック
│       └── services/
│           └── googleDriveService.ts   # Google API呼び出し
├── types/
│   └── google.d.ts                     # Google API型定義
└── utils/
    └── export.ts                       # データ変換（既存）
```

---

## 将来の拡張

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 自動同期 | 定期的にバックグラウンド同期 | 低 |
| 同期履歴 | 過去の同期日時を表示 | 低 |
| 複数バージョン保持 | 過去N回分のバックアップを保持 | 低 |
| 差分同期 | 変更分のみ同期 | 低 |

現時点では手動同期のシンプルな実装を優先し、ユーザーからのフィードバックに応じて拡張を検討する。

---

## 実装状況

### 実装済み機能

| 機能 | 状態 | 備考 |
|------|------|------|
| OAuth 2.0認証 | ✅ 完了 | Google Identity Services使用 |
| App Data Folder保存 | ✅ 完了 | plalog-data.jsonとして保存 |
| アップロード | ✅ 完了 | 新規作成・上書き更新対応 |
| ダウンロード | ✅ 完了 | 既存データ上書き |
| 連携解除 | ✅ 完了 | トークン破棄 |
| エラーハンドリング | ✅ 完了 | Toast通知表示 |

### 実装ファイル

```
src/features/settings/
├── components/
│   ├── AutoSyncNotification.tsx   # 自動同期通知
│   └── SyncConfirmDialog.tsx      # 確認ダイアログ
├── hooks/
│   ├── useAutoSync.ts             # 自動同期ロジック
│   └── useGoogleDriveSync.ts      # Google Drive同期
├── pages/
│   └── GoogleDriveSyncPage.tsx    # 同期画面
└── services/
    └── googleDriveService.ts      # Google Drive API
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2024-12-28 | 1.0 | 初版作成 |
| 2024-12-30 | 1.1 | 実装状況セクション追加 |
